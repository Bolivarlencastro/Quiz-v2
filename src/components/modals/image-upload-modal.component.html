<div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 animate-fade-in" (click)="close.emit()">
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-5xl h-[80vh] flex m-4 animate-scale-up" (click)="$event.stopPropagation()">
    <!-- Sidebar -->
    <aside class="w-64 bg-gray-50 dark:bg-gray-800/50 p-4 border-r dark:border-gray-700 flex flex-col">
        <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-6">Fonte da Imagem</h2>
        <nav class="flex flex-col gap-2">
            @for (source of [
                {id: 'computer', name: 'Meu Computador', icon: 'devices'}, 
                {id: 'drive', name: 'Drive', icon: 'cloud_upload'}, 
                {id: 'pexels', name: 'Pexels', icon: 'photo_camera'}, 
                {id: 'freepik', name: 'Freepik', icon: 'brush'}, 
                {id: 'ai', name: 'Gerar com IA', icon: 'auto_awesome'}
            ]; track source.id) {
                <button (click)="selectSource(source.id)" class="flex items-center gap-3 p-3 rounded-lg text-left transition-colors" [class.bg-indigo-100]="activeSource() === source.id" [class.dark:bg-indigo-900/40]="activeSource() === source.id" [class.text-indigo-700]="activeSource() === source.id" [class.dark:text-indigo-400]="activeSource() === source.id" [class.hover:bg-gray-200]="activeSource() !== source.id" [class.dark:hover:bg-gray-700]="activeSource() !== source.id">
                    <span class="material-symbols-outlined">{{ source.icon }}</span>
                    <span class="font-semibold">{{ source.name }}</span>
                </button>
            }
        </nav>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col">
        <header class="p-4 border-b dark:border-gray-700 flex justify-between items-center">
            <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300">
              @switch(activeSource()) {
                @case('computer') { Upload do Computador }
                @case('drive') { Selecionar do Drive }
                @case('pexels') { Buscar no Pexels }
                @case('freepik') { Buscar no Freepik }
                @case('ai') { Gerar Imagem com Inteligência Artificial }
              }
            </h3>
            <button (click)="close.emit()" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-400">
                <span class="material-symbols-outlined">close</span>
            </button>
        </header>

        <main class="flex-1 overflow-y-auto p-6 flex">
          @switch(activeSource()) {
            @case('computer') {
              <div class="h-full flex flex-col items-center justify-center">
                <label for="file-upload" 
                  class="w-full h-full flex flex-col items-center justify-center border-2 border-dashed rounded-lg cursor-pointer transition-colors"
                  [class.border-indigo-500]="draggingOver()"
                  [class.bg-indigo-50]="draggingOver()"
                  [class.dark:bg-indigo-900/20]="draggingOver()"
                  [class.border-gray-300]="!draggingOver()"
                  [class.dark:border-gray-600]="!draggingOver()"
                  (dragover)="onDragOver($event)" 
                  (dragleave)="onDragLeave($event)" 
                  (drop)="onDrop($event)">
                    <span class="material-symbols-outlined text-6xl text-gray-400 dark:text-gray-500">upload_file</span>
                    <p class="mt-2 text-lg text-gray-600 dark:text-gray-300 font-semibold">Arraste e solte o arquivo aqui</p>
                    <p class="text-gray-500 dark:text-gray-400">ou</p>
                    <span class="mt-2 bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">Selecione o arquivo</span>
                </label>
                <input id="file-upload" type="file" class="sr-only" accept="image/*" (change)="onFileSelected($event)">
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-4">
                  @if (imageType() === 'banner') {
                    Resolução recomendada: 1920x540
                  } @else {
                    Resolução recomendada: 540x320
                  }
                </p>
              </div>
            }
            @case('drive') {
              <div class="h-full flex flex-col items-center justify-center text-center text-gray-500 dark:text-gray-400">
                <span class="material-symbols-outlined text-6xl">cloud_off</span>
                <h4 class="mt-4 text-lg font-semibold text-gray-800 dark:text-gray-200">Funcionalidade em desenvolvimento</h4>
                <p>A integração com o Drive estará disponível em breve.</p>
              </div>
            }
            @case('pexels') {
              <div>
                <div class="flex gap-2 mb-4">
                  <input type="text" [(ngModel)]="bankSearchTerm" (keyup.enter)="searchBank()" placeholder="Buscar imagens no Pexels..." class="flex-1 px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg">
                  <button (click)="searchBank()" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">Buscar</button>
                </div>
                @if(isLoading()) {
                   <div class="flex justify-center items-center h-64"><p>Carregando imagens...</p></div>
                } @else {
                  <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    @for(image of bankImages(); track image) {
                      <div (click)="selectBankImage(image)" class="aspect-video bg-gray-200 rounded-lg overflow-hidden cursor-pointer group relative">
                        <img [src]="image" alt="Imagem do banco" class="w-full h-full object-cover transition-transform group-hover:scale-110">
                        <div class="absolute inset-0 bg-black/30 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                          <span class="material-symbols-outlined text-4xl text-white">check_circle</span>
                        </div>
                      </div>
                    }
                  </div>
                }
              </div>
            }
            @case('freepik') {
              <div>
                <div class="flex gap-2 mb-4">
                  <input type="text" [(ngModel)]="bankSearchTerm" (keyup.enter)="searchBank()" placeholder="Buscar imagens no Freepik..." class="flex-1 px-4 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg">
                  <button (click)="searchBank()" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">Buscar</button>
                </div>
                @if(isLoading()) {
                   <div class="flex justify-center items-center h-64"><p>Carregando imagens...</p></div>
                } @else {
                  <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    @for(image of bankImages(); track image) {
                      <div (click)="selectBankImage(image)" class="aspect-video bg-gray-200 rounded-lg overflow-hidden cursor-pointer group relative">
                        <img [src]="image" alt="Imagem do banco" class="w-full h-full object-cover transition-transform group-hover:scale-110">
                        <div class="absolute inset-0 bg-black/30 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                          <span class="material-symbols-outlined text-4xl text-white">check_circle</span>
                        </div>
                      </div>
                    }
                  </div>
                }
              </div>
            }
             @case('ai') {
              <div class="flex flex-col h-full bg-gray-100 dark:bg-gray-900 -m-6 w-full">
                <!-- Chat History (scrollable) -->
                <div class="flex-1 overflow-y-auto p-4 space-y-6">
                  @if (aiChatHistory().length === 0) {
                    <div class="h-full flex flex-col items-center justify-center text-center text-gray-500 dark:text-gray-400">
                      <span class="material-symbols-outlined text-6xl">chat_bubble</span>
                      <p class="mt-2 font-semibold text-lg text-gray-700 dark:text-gray-300">Seu histórico de geração aparecerá aqui.</p>
                      <p class="text-sm">Comece descrevendo a imagem que você quer criar.</p>
                    </div>
                  } @else {
                    @for (entry of aiChatHistory(); track entry.timestamp) {
                      <!-- User Prompt -->
                      <div class="flex justify-end">
                        <div class="bg-indigo-600 text-white rounded-2xl rounded-br-none p-3 max-w-lg shadow-md">
                          <p>{{ entry.prompt }}</p>
                          <p class="text-xs text-indigo-200 text-right mt-1">{{ entry.timestamp | date:'shortTime' }}</p>
                        </div>
                      </div>

                      <!-- AI Response -->
                      <div class="flex justify-start">
                        <div class="bg-white dark:bg-gray-700 rounded-2xl rounded-bl-none p-3 max-w-lg shadow-md">
                          @if (entry.isLoading) {
                            <div class="flex items-center gap-3 text-gray-600 dark:text-gray-300">
                              <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                              <span>Gerando imagens...</span>
                            </div>
                          } @else if (entry.error) {
                            <p class="text-red-500 font-semibold">{{ entry.error }}</p>
                          } @else {
                            <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">Aqui estão 2 opções para você:</p>
                            <div class="grid grid-cols-2 gap-2">
                              @for (image of entry.images; track image) {
                                <div class="relative group">
                                  <img [src]="image" (click)="imageSelected.emit(image)" alt="Imagem gerada por IA" class="rounded-md cursor-pointer group-hover:ring-4 group-hover:ring-indigo-500 transition-all shadow w-full h-full object-cover"/>
                                  <a [href]="image" download="konquest-ai-image.jpeg" (click)="$event.stopPropagation()" [appTooltip]="'Fazer download'" class="absolute top-2 right-2 bg-black/50 text-white rounded-full w-8 h-8 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity hover:bg-black/70">
                                    <span class="material-symbols-outlined text-base">download</span>
                                  </a>
                                </div>
                              }
                            </div>
                             <div class="mt-2 flex justify-end items-center">
                              <button (click)="regenerateImages(entry)" [disabled]="isLoading()" class="flex items-center gap-1.5 text-sm font-semibold text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 disabled:opacity-50 disabled:cursor-not-allowed">
                                <span class="material-symbols-outlined text-base">cached</span>
                                Regenerar
                              </button>
                            </div>
                          }
                        </div>
                      </div>
                    }
                  }
                </div>

                <!-- Prompt Input (fixed bottom) -->
                <div class="shrink-0 p-4 border-t dark:border-gray-700 bg-white dark:bg-gray-800">
                   @if (aiReferenceImage(); as refImage) {
                    <div class="mb-2">
                      <div class="inline-block relative w-24 p-1 border rounded-lg dark:border-gray-600 bg-gray-100 dark:bg-gray-900">
                        <img [src]="'data:' + refImage.mimeType + ';base64,' + refImage.base64" alt="Imagem de referência" class="w-full h-auto object-cover rounded">
                        <button (click)="removeReferenceImage()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center hover:bg-red-600 transition shadow">
                          <span class="material-symbols-outlined text-sm">close</span>
                        </button>
                      </div>
                    </div>
                  }
                  
                  <div class="relative">
                    <textarea 
                      [(ngModel)]="aiPrompt" 
                      (keydown)="handleKeydown($event)"
                      (input)="adjustTextareaHeight($event)"
                      [disabled]="isLoading()"
                      placeholder="Start typing a prompt" 
                      rows="1"
                      class="w-full pl-4 pr-24 py-3 bg-white dark:bg-gray-700/50 border border-gray-300 dark:border-gray-600 rounded-full resize-none focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all text-gray-800 dark:text-gray-200 leading-tight overflow-hidden"
                      style="min-height: 50px; max-height: 200px;"></textarea>
                    
                    <div class="absolute right-3 top-1/2 -translate-y-1/2 flex items-center gap-2">
                      <button (click)="refImageInput.click()" [disabled]="isLoading() || !!aiReferenceImage()"
                              [appTooltip]="'Insert assets such as images, videos, folders, files, or audio'"
                              class="w-8 h-8 flex items-center justify-center bg-gray-200 dark:bg-gray-600 rounded-full hover:bg-gray-300 dark:hover:bg-gray-500 disabled:opacity-50 text-gray-600 dark:text-gray-300">
                          <span class="material-symbols-outlined text-lg">add</span>
                      </button>
                      <input #refImageInput type="file" class="hidden" accept="image/*" (change)="onReferenceImageSelected($event)">
                      
                      <button 
                        (click)="generateImage()" 
                        [disabled]="!aiPrompt().trim() || isLoading()" 
                        class="bg-gray-800 dark:bg-gray-200 text-white dark:text-black rounded-full w-8 h-8 flex items-center justify-center hover:bg-gray-900 dark:hover:bg-white transition disabled:opacity-50 disabled:cursor-not-allowed">
                          @if (isLoading()) {
                            <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                          } @else {
                             <span class="material-symbols-outlined text-lg">arrow_upward</span>
                          }
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            }
          }
        </main>
    </div>
  </div>
</div>

<style>
  .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
  .animate-scale-up { animation: scaleUp 0.3s ease-out forwards; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes scaleUp { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
</style>