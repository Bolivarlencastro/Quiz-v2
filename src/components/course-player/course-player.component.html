<!-- Main container with padding -->
<div class="h-screen w-screen bg-[#f7f7f7] p-2 flex flex-col" [class.fixed]="isFullScreen()" [class.inset-0]="isFullScreen()" [class.z-50]="isFullScreen()">

  <!-- Top Header -->
  <header class="flex-shrink-0 w-full h-16 flex items-center justify-between px-2">
    <!-- Left side: Menu button and Title -->
    <div class="flex items-center gap-4">
      <button (click)="toggleEntireSidebar()" class="w-12 h-12 flex items-center justify-center rounded-lg text-gray-500 hover:bg-gray-200">
        <span class="material-symbols-outlined">menu</span>
      </button>
      <h1 class="text-lg font-semibold text-gray-800">{{ course().name }}</h1>
    </div>

    <!-- Right side: Navigation and Progress -->
    <div class="flex items-center gap-6">
      <div class="flex items-center gap-2">
        <button (click)="prevContent()" [disabled]="activeContentIndex() === 0" class="w-8 h-8 flex items-center justify-center rounded-full text-gray-500 hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">
          <span class="material-symbols-outlined">arrow_back</span>
        </button>
        <span class="text-sm font-medium text-gray-600 w-12 text-center">{{ activeContentIndex() + 1 }} de {{ allContentItems().length }}</span>
        <button (click)="nextContent()" [disabled]="activeContentIndex() === allContentItems().length - 1" class="w-8 h-8 flex items-center justify-center rounded-full text-gray-500 hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">
          <span class="material-symbols-outlined">arrow_forward</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Main content area -->
  <div class="flex-1 flex gap-2 overflow-hidden">
    <!-- Primary + Secondary Sidebar container -->
    <div class="flex-shrink-0 flex gap-2 transition-all duration-300" 
         [class.-ml-[384px]]="isEntireSidebarCollapsed()"
         [class.w-0]="isEntireSidebarCollapsed()">
      
      <!-- Primary Icon Sidebar -->
      <aside class="flex-shrink-0 w-20 bg-white rounded-2xl flex flex-col items-center py-4">
        <!-- Index toggle button -->
        <button (click)="toggleIndex()" 
                class="w-14 h-14 flex items-center justify-center rounded-2xl transition-colors mb-4"
                [class.bg-purple-100]="!isIndexCollapsed()"
                [class.text-purple-600]="!isIndexCollapsed()"
                [class.hover:bg-gray-100]="isIndexCollapsed()">
          <span class="material-symbols-outlined">list</span>
        </button>
        
        <div class="flex-grow"></div>
        
        <!-- Bottom Icons -->
        <div class="flex flex-col gap-2">
          <button class="w-14 h-14 flex items-center justify-center rounded-2xl text-gray-500 hover:bg-gray-100">
            <span class="material-symbols-outlined">help_outline</span>
          </button>
          <button (click)="toggleFullScreen.emit()" class="w-14 h-14 flex items-center justify-center rounded-2xl text-gray-500 hover:bg-gray-100">
            <span class="material-symbols-outlined">{{ isFullScreen() ? 'fullscreen_exit' : 'fullscreen' }}</span>
          </button>
          <button class="w-14 h-14 flex items-center justify-center rounded-2xl text-gray-500 hover:bg-gray-100">
            <span class="material-symbols-outlined">dark_mode</span>
          </button>
          <button (click)="showExitConfirmModal.set(true)" class="w-14 h-14 flex items-center justify-center rounded-2xl text-gray-500 hover:bg-gray-100">
            <span class="material-symbols-outlined">logout</span>
          </button>
        </div>
      </aside>

      <!-- Secondary Index Menu -->
      <nav class="flex-shrink-0 w-[300px] bg-white rounded-2xl p-2 flex flex-col transition-all duration-300"
           [class.-ml-[308px]]="isIndexCollapsed()"
           [class.opacity-0]="isIndexCollapsed()"
           [class.pointer-events-none]="isIndexCollapsed()">
        <div class="overflow-y-auto space-y-2">
          @for (topic of course().topics; track topic.id; let topicIndex = $index) {
            <div class="bg-white rounded-2xl overflow-hidden">
              <!-- Topic Header -->
              <button (click)="toggleTopicExpansion(topic.id)" class="w-full flex items-center justify-between p-4 text-left">
                <div class="flex items-center gap-4">
                  <div class="w-8 h-8 flex-shrink-0 flex items-center justify-center bg-gray-100 rounded-full font-bold text-sm text-gray-600">
                    {{ topicIndex + 1 }}
                  </div>
                  <span class="font-semibold text-gray-800">{{ topic.title }}</span>
                </div>
                <span class="material-symbols-outlined text-gray-500 transition-transform" [class.rotate-180]="!isTopicExpanded(topic.id)">expand_more</span>
              </button>
              
              <!-- Content List -->
              @if (isTopicExpanded(topic.id)) {
                <div class="pl-8 pr-4 pb-2">
                  <div class="border-l-2 border-gray-200">
                    @for (content of topic.contents; track content.id) {
                      <a (click)="selectContent(content)" 
                         class="flex items-center gap-3 pl-5 pr-2 py-3 -ml-px border-l-2 transition-colors cursor-pointer"
                         [class.border-purple-600]="activeContent()?.id === content.id"
                         [class.text-purple-600]="activeContent()?.id === content.id"
                         [class.font-semibold]="activeContent()?.id === content.id"
                         [class.border-transparent]="activeContent()?.id !== content.id"
                         [class.text-gray-600]="activeContent()?.id !== content.id"
                         [class.hover:text-gray-900]="activeContent()?.id !== content.id">
                        <span class="material-symbols-outlined text-base w-5 text-center">{{ getContentIcon(content.type) }}</span>
                        <span class="truncate text-sm">{{ content.title }}</span>
                      </a>
                    }
                  </div>
                </div>
              }
            </div>
          }
        </div>
      </nav>
    </div>

    <!-- Main Content Display -->
    <main class="flex-1 bg-white rounded-2xl overflow-y-auto flex p-4"
          [class.items-center]="activeContent()?.type !== 'video' && activeContent()?.type !== 'quiz'"
          [class.justify-center]="activeContent()?.type !== 'video' && activeContent()?.type !== 'quiz'">
      @if (activeContent(); as content) {
        @switch (content.type) {
          @case ('video') {
            @if (safeVideoUrl(); as url) {
              <div class="w-full h-full">
                <iframe [src]="url" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen class="w-full h-full rounded-lg"></iframe>
              </div>
            } @else {
              <div class="text-center text-gray-500">
                <span class="material-symbols-outlined text-5xl">videocam_off</span>
                <p class="mt-2">Preview de vídeo não disponível.</p>
                <p class="text-sm text-gray-400">Verifique se o link do YouTube é válido.</p>
              </div>
            }
          }
          @case('quiz') {
            @if (content.quizData; as quiz) {
              <app-quiz-player class="w-full" [quizData]="quiz" [isInlinePlayer]="true" (quizCompleted)="nextContent()" />
            }
          }
          @default {
            <div class="text-center text-gray-700">
              <h1 class="text-2xl font-bold">{{ activeTopicIndex() + 1 }}.{{ activeContentIndexInTopic() + 1 }} {{ content.title }}</h1>
            </div>
          }
        }
      } @else {
        <div class="text-center text-gray-500">
          <p>Selecione um conteúdo para começar.</p>
        </div>
      }
    </main>
  </div>
</div>

<!-- Exit Confirmation Modal -->
@if(showExitConfirmModal()) {
  <div class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-8 m-4 text-center">
      <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100">
        <span class="material-symbols-outlined text-3xl text-yellow-600">warning</span>
      </div>
      <h3 class="mt-4 text-2xl font-bold text-gray-800">Abandonar o curso?</h3>
      <p class="mt-2 text-gray-600">
        Tem certeza que deseja sair? Seu progresso não será salvo.
      </p>
      <div class="mt-8 grid grid-cols-2 gap-4">
        <button (click)="cancelExit()" class="bg-gray-100 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-200 transition">
          Cancelar
        </button>
        <button (click)="confirmExit()" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition">
          Sair
        </button>
      </div>
    </div>
  </div>
}